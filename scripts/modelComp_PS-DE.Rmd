---
title: "Hierarchical Bayesian Models of RT speedup"
author: "Jarrett Lovelett"
date: "7/2/2018"
output: html_document
---

# Overview  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message=F)
library(tidyverse)
library(lubridate)
library(rstan)
library(loo)
rm(list=ls())
```

```{r load data & pre-process}
load('../data/mostRecentPredDat_PS.rdata')
load('../data/mostRecentPredDat_DE.rdata')

pred.dat = pred.dat.ps %>% 
  left_join(pred.dat.de)

load('../data/mostRecentPredDat_PS_noRevert.rdata')
load('../data/mostRecentPredDat_DE_noRevert.rdata')
pred.dat.noRevert = pred.dat.ps.noRevert %>% 
  left_join(pred.dat.de.noRevert)

load('../data/mostRecentPredDat_PS_onlyRevert.rdata')
load('../data/mostRecentPredDat_DE_onlyRevert.rdata')
pred.dat.onlyRevert = pred.dat.ps.onlyRevert %>% 
  left_join(pred.dat.de.onlyRevert)

rm(pred.dat.ps, pred.dat.de, pred.dat.ps.noRevert, pred.dat.de.noRevert,
   pred.dat.ps.onlyRevert, pred.dat.de.onlyRevert)
```

# Plots

## Including Reversion Trials

```{r make plots if reversions, fig.height=40, fig.width=25 }
# NOTE: overwrites current version
sub.plot = pred.dat %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)+
  theme_linedraw()

sub.plot %>%  ggsave(filename=paste0('subj-item_',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot
```

## Excluding Reversion Trials

```{r make plots if no reversions, fig.height=40, fig.width=25 }
# NOTE: overwrites current version
sub.plot.noRevert = pred.dat.noRevert %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)+
  theme_linedraw()

sub.plot.noRevert %>%  ggsave(filename=paste0('subj-item_noRevert',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot.noRevert
```


## Only Reversion Trials

```{r make plots if only reversions, fig.height=40, fig.width=25 }
# NOTE: overwrites current version
sub.plot.onlyRevert = pred.dat.onlyRevert %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)+
  theme_linedraw()

sub.plot.onlyRevert %>%  ggsave(filename=paste0('subj-item_onlyRevert',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot.onlyRevert
```
# Model Comparison

## R^2

```{r Model Comparison: R^2}
# R^2_adj = 1 - { [(1-R^2)(n-1)] / (n-k-1) }

# does this account for offsets too? or just overall?
k.ps = 3 # Alg_M, Ret_B, Ret_T = 3 (plus eventual P(shift) param theta)
k.de = 4 # alpha, beta, tau, r = 4

# note: if num params includes the hierarchical nature of params, be careful of potentially poorly-behaved adj r^2 when k >> 1 
r2.adj = function(x, y, k){
  n = length(x)
  if(n != length(y)){
    stop("x and y have different lengths!")
  }
  r2 = cor(x,y)^2
  1 - (1-r2) * ( (n-1)/(n-k-1) )
}

r2.results = c(ps = with(pred.dat, r2.adj(logRT,pred.logRT.ps,k.ps)),
               de = with(pred.dat, r2.adj(logRT,pred.logRT.de,k.de)),
               ps.noRever = with(pred.dat.noRevert, 
                                 r2.adj(logRT, pred.logRT.ps, k.ps)),
               de.noRever = with(pred.dat.noRevert, 
                                 r2.adj(logRT, pred.logRT.de, k.ps)),
               ps.onlyRever = with(pred.dat.onlyRevert,
                                   r2.adj(logRT, pred.logRT.ps, k.ps)),
               de.onlyRever = with(pred.dat.onlyRevert,
                                   r2.adj(logRT, pred.logRT.de, k.ps)))
r2.results
```

## WAIC
```{r}
# http://mc-stan.org/loo/articles/loo2-example.html
# If we had written our own Stan program instead of using rstanarm we would pass an array or matrix of log-liklihood values to the loo function (see, e.g. help("loo.array", package = "loo"))

# PS log likelihood / waic
load('../large_data/stanoutput_ps_Thu Jul_12_16-03-12_2018.rdata')
log.lik.ps = extract_log_lik(fit.ps, parameter_name = "logLik", merge_chains = TRUE)
waic.ps = waic(log.lik.ps)
waic.loo.ps = loo(log.lik.ps)
rm(fit.ps)

# PS (no reversions) log likelihood / waic
load('../large_data/stanoutput_ps_noRevertThu_Jul_26_00-19-39_2018.rdata')
#load('../large_data/stanoutput_ps_noRevertThu Jul 12 17:39:10 2018.rdata')
log.lik.ps.nr = extract_log_lik(fit.ps, parameter_name = "logLik", merge_chains = TRUE)
waic.ps.nr = waic(log.lik.ps.nr)
waic.loo.ps.nr = loo(log.lik.ps.nr)
rm(fit.ps)

# PS (only reversions) log likelihood / waic
load('../large_data/stanoutput_ps_onlyRevertWed_Jul_25_22-40-03_2018.rdata')
log.lik.ps.or = extract_log_lik(fit.ps, parameter_name = "logLik", merge_chains = TRUE)
waic.ps.or = waic(log.lik.ps.or)
waic.loo.ps.or = loo(log.lik.ps.or)
rm(fit.ps)

# DE log likelihood / waic
load('../large_data/stanoutput_de_Tue_Jul_10_19-54-11_2018.rdata')
log.lik.de = extract_log_lik(fit.de, parameter_name = "logLik", merge_chains = TRUE)
waic.de = waic(log.lik.de)
waic.loo.de = loo(log.lik.de)
rm(fit.de)

# DE (no reversions) log likelihood / waic
load('../large_data/stanoutput_de_noRevertFri_Jul_27_10-07-22-2018.rdata')
log.lik.de.nr = extract_log_lik(fit.de, parameter_name = "logLik", merge_chains = TRUE)
waic.de.nr = waic(log.lik.de.nr)
waic.loo.de.nr = loo(log.lik.de.nr)
rm(fit.de)

# DE (only reversions) log likelihood / waic
load('../large_data/stanoutput_de_onlyRevertThu_Jul_26_12-54-42_2018.rdata')
log.lik.de.or = extract_log_lik(fit.de, parameter_name = "logLik", merge_chains = TRUE)
waic.de.or = waic(log.lik.de.or)
waic.loo.de.or = loo(log.lik.de.or)
rm(fit.de)

waics = data_frame(
  model = c('PS','PS_noRevert','PS_onlyRevert','DE','DE_noRevert','DE_onlyRevert'),
  waic = c(waic.ps$estimates['waic','Estimate'],
           waic.ps.nr$estimates['waic','Estimate'],
           waic.ps.or$estimates['waic','Estimate'],
           waic.de$estimates['waic','Estimate'],
           waic.de.nr$estimates['waic','Estimate'],
           waic.de.or$estimates['waic','Estimate']),
  waic_loo = c(waic.loo.ps$estimates['looic','Estimate'], 
               waic.loo.ps.nr$estimates['looic','Estimate'],
               waic.loo.ps.or$estimates['looic','Estimate'],
               waic.loo.de$estimates['looic','Estimate'], 
               waic.loo.de.nr$estimates['looic','Estimate'],
               waic.loo.de.or$estimates['looic','Estimate'])
  )

knitr::kable(waics)

```


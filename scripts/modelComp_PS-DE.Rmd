---
title: "Hierarchical Bayesian Models of RT speedup"
author: "Jarrett Lovelett"
date: "7/2/2018"
output: html_document
---

# Overview  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(rstan)
library(loo)
rm(list=ls())
```

```{r load data & pre-process}
load('../data/mostRecentPredDat_PS.rdata')
load('../data/mostRecentPredDat_DE.rdata')

pred.dat = pred.dat.ps %>% 
  left_join(pred.dat.de)

load('../data/mostRecentPredDat_PS_noRevert.rdata')
load('../data/mostRecentPredDat_DE_noRevert.rdata')
pred.dat.noRevert = pred.dat.ps.noRevert %>% 
  left_join(pred.dat.de.noRevert)

rm(pred.dat.ps, pred.dat.de, pred.dat.ps.noRevert, pred.dat.de.noRevert)
```

# Plots

## Including Reversion Trials

```{r make plots if reversions }
# NOTE: overwrites current version
sub.plot = pred.dat %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy, group=strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)

sub.plot %>%  ggsave(filename=paste0('subj-item_',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot
```

## Excluding Reversion Trials

```{r make plots if no reversions }
# NOTE: overwrites current version
sub.plot.noRevert = pred.dat.noRevert %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy, group=strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)

sub.plot.noRevert %>%  ggsave(filename=paste0('subj-item_noRevert',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot.noRevert
```

# Model Comparison

## R^2

```{r Model Comparison: R^2}
# R^2_adj = 1 - { [(1-R^2)(n-1)] / (n-k-1) }

# does this account for offsets too? or just overall?
k.ps = 3 # Alg_M, Ret_B, Ret_T = 3 (plus eventual P(shift) param theta)
k.de = 4 # alpha, beta, tau, r = 4

# note: if num params includes the hierarchical nature of params, be careful of potentially poorly-behaved adj r^2 when k >> 1 
r2.adj = function(x, y, k){
  n = length(x)
  if(n != length(y)){
    stop("x and y have different lengths!")
  }
  r2 = cor(x,y)^2
  1 - (1-r2) * ( (n-1)/(n-k-1) )
}

r2.results = c(ps = with(pred.dat, r2.adj(logRT,pred.logRT.ps,k.ps)),
               #de = with(pred.dat, r2.adj(logRT,pred.logRT.de,k.de)),
               ps.noRever = with(pred.dat.noRevert, 
                                 r2.adj(logRT, pred.logRT.ps, k.ps)),
               de.noRever = with(pred.dat.noRevert, 
                                 r2.adj(logRT, pred.logRT.de, k.ps))
               )
r2.results
```

## WAIC
```{r}
# http://mc-stan.org/loo/articles/loo2-example.html
# If we had written our own Stan program instead of using rstanarm we would pass an array or matrix of log-liklihood values to the loo function (see, e.g. help("loo.array", package = "loo"))

load('../large_data/stanoutput_ps_Mon Jul  2 12:07:07 2018.rdata')
log.lik.ps = extract_log_lik(fit.ps, parameter_name = "logLik", merge_chains = TRUE)
waic.ps = waic(log.lik.ps)
waic.loo.ps = loo(log.lik.ps)
rm(fit.ps)

load('../large_data/stanoutput_ps_noRevertMon Jul  2 22:18:12 2018.rdata')
log.lik.ps.nr = extract_log_lik(fit.ps, parameter_name = "logLik", merge_chains = TRUE)
waic.ps.nr = waic(log.lik.ps.nr)
waic.loo.ps.nr = loo(log.lik.ps.nr)
rm(fit.ps)

load('../large_data/stanoutput_de_Tue Jul 10 19:54:11 2018.rdata')
log.lik.de = extract_log_lik(fit.de, parameter_name = "logLik", merge_chains = TRUE)
waic.de = waic(log.lik.de)
waic.loo.de = loo(log.lik.de)
rm(fit.de)

load('../large_data/stanoutput_de_noRevertWed Jul 11 01/20/43 2018.rdata')
log.lik.de.nr = extract_log_lik(fit.de, parameter_name = "logLik", merge_chains = T RUE)
waic.de.nr = waic(log.lik.de.nr)
waic.loo.de.nr = loo(log.lik.de.nr)
rm(fit.de)

waics = data_frame(model = c('PS','PS_noRevert','DE','DE_noRevert'),
                   waic = c(waic.ps, waic.ps.nr, NA,waic.de.nr),
                   waic_loo = c(waic.loo.ps, waic.loo.ps.nr, NA, waic.loo.de.nr))

kable::waics

```


---
title: "Hierarchical Bayesian Models of RT speedup"
author: "Jarrett Lovelett"
date: "7/2/2018"
output: html_document
---

# Overview  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message=F)
library(tidyverse)
library(lubridate)
library(rstan)
library(loo)
rm(list=ls())
```

```{r load data & pre-process}
load('../data/mostRecentPredDat_PS.rdata')
load('../data/mostRecentPredDat_DE.rdata')

pred.dat = pred.dat.ps %>% 
  left_join(pred.dat.de)

load('../data/mostRecentPredDat_PS_noRevert.rdata')
load('../data/mostRecentPredDat_DE_noRevert.rdata')
pred.dat.noRevert = pred.dat.ps.noRevert %>% 
  left_join(pred.dat.de.noRevert)

load('../data/mostRecentPredDat_PS_onlyRevert.rdata')
load('../data/mostRecentPredDat_DE_onlyRevert.rdata')
pred.dat.onlyRevert = pred.dat.ps.onlyRevert %>% 
  left_join(pred.dat.de.onlyRevert)

rm(pred.dat.ps, pred.dat.de, pred.dat.ps.noRevert, pred.dat.de.noRevert,
   pred.dat.ps.onlyRevert, pred.dat.de.onlyRevert)

# use these later on to pull only relevant logLik out of fitted model
trials.reversions = which(pred.dat$reversions==TRUE)
trials.noReversions = which(pred.dat$reversions==FALSE)
  
```

# Plots

## Including Reversion Trials

```{r make plots if reversions, fig.height=40, fig.width=25 }
# NOTE: overwrites current version
sub.plot = pred.dat %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)+
  theme_linedraw()

sub.plot %>%  ggsave(filename=paste0('subj-item_',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot
```

## Excluding Reversion Trials

```{r make plots if no reversions, fig.height=40, fig.width=25 }
# NOTE: overwrites current version
sub.plot.noRevert = pred.dat.noRevert %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)+
  theme_linedraw()

sub.plot.noRevert %>%  ggsave(filename=paste0('subj-item_noRevert',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot.noRevert
```


## Only Reversion Trials

```{r make plots if only reversions, fig.height=40, fig.width=25 }
# NOTE: overwrites current version
sub.plot.onlyRevert = pred.dat.onlyRevert %>%
         mutate(strategy = as.factor(strategy),
                item = as.factor(item)) %>%
  ggplot(aes(x = trial, color = strategy))+
  geom_point(aes(y=logRT))+
  geom_line(aes(y=pred.logRT.de), color = 'green')+
  geom_line(aes(y=pred.logRT.ps), color = 'blue')+
  geom_vline(aes(xintercept=first.correct.trial.item))+
  facet_grid(subject~item)+
  theme_linedraw()

sub.plot.onlyRevert %>%  ggsave(filename=paste0('subj-item_onlyRevert',now(),'.pdf'),path='../plots/', width = 25, height = 40, device= 'pdf')

sub.plot.onlyRevert
```
# Model Comparison

## WAIC  
 

```{r}

# PS log likelihood / waic
load('../large_data/stanoutput_ps_Thu Jul_12_16-03-12_2018.rdata')
log.lik.ps = extract_log_lik(fit.ps, parameter_name = "logLik", merge_chains = TRUE)
waic.ps = waic(log.lik.ps)$estimates['waic','Estimate']
#waic.loo.ps = loo(log.lik.ps)
rm(fit.ps)

# PS (only reversions) log likelihood / waic
waic.ps.reversions = waic(log.lik.ps[,trials.reversions])$estimates['waic','Estimate']
#waic.loo.ps.reversions = loo(log.lik.ps.reversions)

# PS (no reversions) log likelihood / waic
waic.ps.noReversions = waic(log.lik.ps[,trials.noReversions])$estimates['waic','Estimate']
#waic.loo.ps.noReversions = loo(log.lik.ps.noReversions)

# DE log likelihood / waic
load('../large_data/stanoutput_de_Tue_Jul_10_19-54-11_2018.rdata')
log.lik.de = extract_log_lik(fit.de, parameter_name = "logLik", merge_chains = TRUE)
waic.de = waic(log.lik.de)$estimates['waic','Estimate']
#waic.loo.de = loo(log.lik.de)
rm(fit.de)

# DE (only reversions) log likelihood / waic
waic.de.reversions = waic(log.lik.de[,trials.reversions])$estimates['waic','Estimate']
#waic.loo.de.reversions = loo(log.lik.de.reversions)

# DE (no reversions) log likelihood / waic
waic.de.noReversions = waic(log.lik.de[,trials.noReversions])$estimates['waic','Estimate']
#waic.loo.de.noReversions = loo(log.lik.de.noReversions)


waics = data_frame(
  model = rep(c('Process Shift','Delayed Exponential'),times = 3),
  data = c('full','full',
            'noReversions','noReversions',
            'onlyReversions','onlyReversions'),
  waic = c(waic.ps,
           waic.de,
           waic.ps.noReversions,
           waic.de.noReversions,
           waic.ps.reversions,
           waic.de.reversions)#,
  # waic_loo = c(waic.loo.ps$estimates['looic','Estimate'], 
  #              waic.loo.de$estimates['looic','Estimate'], 
  #              waic.loo.ps.noReversions$estimates['looic','Estimate'],
  #              waic.loo.de.noReversions$estimates['looic','Estimate'],
  #              waic.loo.ps.reversions$estimates['looic','Estimate'],
  #              waic.loo.de.reversions$estimates['looic','Estimate'])
  )
```

```{r}
ggplot(waics, aes(x = model, y = waic, fill = model))+
  geom_bar(stat='identity', position = position_dodge())+
  facet_grid(~data)+
  theme_linedraw()+
  scale_x_discrete(name = '', breaks=c(),labels=c())+
  scale_y_continuous(expand=c(0,0))
```

